<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content= "width=device-width, user-scalable=no">
        <title>SHABOOBOO</title>
        <style>
            body {
                margin: 0;
                overflow: hidden;
                background: #000;
                font-family: monospace;
            }
            canvas {
                display: block;
                position: absolute;
                top: 0;
                left: 0;
                z-index: 2;
            }
            #hud {
                position: absolute;
                z-index: 99;
                width: 100%;
                left: 5px;
                top: 5px;
            }
            #hud button {
                margin-bottom: 5px;
                margin-right: 5px;
            }
            button:hover {
                cursor: pointer;
            }
            #loading {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: white;
                z-index: 100;
            }
            #subs {
                position: absolute;
                z-index: 99;
                top: 5px;
                right: 5px;
                font-family: monospace;
                text-align: right;
                color: white;
                height: 2em;
                font-size: 70%;
                margin-left: 150px;
                background: rgba(0, 0, 0, 0.8);
                padding: 10px;
                border-left: 4px solid #ff0000;
                line-height: 1.4;
                max-width: 300px;
            }
            #topl {
                display: inline;
                top: 0;
                left: 5px;
                z-index: 99;
            }
            #topl input {width:100px; margin-bottom:5px;}
            
            #words {
                position: absolute;
                bottom: 0;
                left: 0;
                z-index: 999;
                margin: 5px;
                display: block;
            }
            #words button {
                background: transparent;
                border: none;
                color: white;
                font-family: monospace;
                outline: none;
                font-size: 70%;
                padding: 0;
                transition: all 0.2s ease;
            }
            #words button:hover {
                color: red;
                transform: scale(1.1);
            }
            #words button:active {
                transform: scale(0.95);
                color: #ff4444;
            }
            
            .content-buttons {
                margin-top: 10px;
            }
            .content-buttons button {
                background: #333;
                color: white;
                border: 1px solid #555;
                padding: 4px 8px;
                border-radius: 3px;
                font-size: 12px;
                display: block;
            }
            .content-buttons button:hover {
                background: #555;
                border-color: #777;
            }
            #deletetext {
                display: inline;
            }
        </style>

        <script type="importmap">
            {
                "imports": {
                    "three": "https://unpkg.com/three@0.170.0/build/three.module.js"
                }
            }
        </script>
    </head>
    <body>
        <div id="loading">Loading</div>

        <div id="hud">
            <button id="deletetext">DEL</button>
            <form id="topl" onsubmit="sendrant();return false">
            <input type="text" size="32" name="isay" id="textinput" autocomplete="off" value="<adj> <noun> has <adv> <verb.ed> a <noun>" >
            <button type="submit" value="Send" id="tellme" >&gt;</button>
            </form>

            
            
            <div class="content-buttons">
                <button id="newsbtn">üì∞ News</button>
                <button id="weatherbtn">üå§Ô∏è Weather</button>
                <button id="sportsbtn">‚öΩ Sports</button>
                <button id="techbtn">üíª Tech</button>
                <button id="celebbtn">üåü Celebrity</button>
                <button id="storybtn">üìñ Story</button>
                <button id="rantbtn">üé≠ Rant</button>
                <button id="poembtn">üìú Poem</button>
            </div>
        </div>

        <div id="words">
            <button>&lt;preposition&gt;</button>
            <button>&lt;firstname&gt;</button>
            <button>&lt;activity&gt;</button>
            <button>&lt;adj&gt;</button>
            <button>&lt;adv&gt;</button>
            <button>&lt;amount&gt;</button>
            <button>&lt;color&gt;</button>
            <button>&lt;conj&gt;</button>
            <button>&lt;country&gt;</button>
            <button>&lt;emo&gt;</button>
            <button>&lt;em&gt;</button>
            <button>&lt;face&gt;</button>
            <button>&lt;greet&gt;</button>
            <button>&lt;surname&gt;</button>
            <button>&lt;noun&gt;</button>
            <button>&lt;sound&gt;</button>
            <button>&lt;title&gt;</button>
            <button>&lt;place&gt;</button>
            <button>&lt;prefix&gt;</button>
            <button>&lt;prepos&gt;</button>
            <button>&lt;pron&gt;</button>
            <button>&lt;quality&gt;</button>
            <button>&lt;rel&gt;</button>
            <button>&lt;sconj&gt;</button>
            <button>&lt;substance&gt;</button>
            <button>&lt;timeadv&gt;</button>
            <button>&lt;timenoun&gt;</button>
            <button>&lt;unit&gt;</button>
            <button>&lt;verbimg&gt;</button>
            <button>&lt;say&gt;</button>
            <button>&lt;verb&gt;</button>
            <button>&lt;vocal&gt;</button>
            <button>&lt;yn&gt;</button>
        </div>

        <div id="subs"></div>

        <script type="text/javascript" src="rant.min.js"></script>

        <script type="module">
            import * as THREE from "three";

            var clicked = false;
            var rnd = 0;
            var oldrnd = 0;
            var speed = 70; // ANIMATION SPEED
            var rate = 0.85; // SPEECH SPEED
            var pitch = 2; // SPEECH PITCH
            var text = "shaboobu";

            // Scene
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x101010);

            //raycaster
            let raycaster = new THREE.Raycaster();
            const pointer = new THREE.Vector2();

            // Camera
            const camera = new THREE.PerspectiveCamera(
                50,
                window.innerWidth / window.innerHeight,
                0.1,
                1000,
            );
            camera.position.set(4, 0, 0);

            // Renderer
            const renderer = new THREE.WebGLRenderer({ 
                antialias: true
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            THREE.ColorManagement.workingColorSpace = THREE.SRGBColorSpace;

            // Lighting
            const ambient = new THREE.AmbientLight(0xcccccc, 1);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            scene.add(ambient, dirLight);

            // hover plane geometry
            let plgeometry = new THREE.PlaneGeometry(10, 10, 1, 1);

            //plane material
            let plmaterial = new THREE.MeshBasicMaterial({
                transparent: true,
                opacity: 0,
            });

            //plane object3D
            let plane = new THREE.Mesh(plgeometry, plmaterial);
            plane.name = "plane";
            plane.rotation.y = Math.PI / 2;
            plane.position.x = 1;
            scene.add(plane);

            // hidden 3D cursor
            const mouseMesh = new THREE.Group();
            mouseMesh.position.x = 1;
            scene.add(mouseMesh);

            const lerpedcursor = new THREE.Group();
            lerpedcursor.position.x = 1;
            scene.add(lerpedcursor);

            // main character group
            const character = new THREE.Group();
            scene.add(character);

            // textures
            var faces = [
                {"n":"0", "col":"sm-face-clean.png", "bump":"sm-facebmp-clean.png"},
                {"n":"1", "col":"sm-face.png", "bump":"sm-facebmp.png"},
                {"n":"2", "col":"sm-faceblink.png", "bump":"sm-facebmp.png"},            
                {"n":"3", "col":"sm-face-A.png", "bump":"sm-facebmp-A.png"},
                {"n":"4", "col":"sm-face-aaa.png", "bump":"sm-facebmp-aaa.png"}, 
                {"n":"5", "col":"sm-face-E.png", "bump":"sm-facebmp-E.png"},
                {"n":"6", "col":"sm-face-L.png", "bump":"sm-facebmp-L.png"},            
                {"n":"7", "col":"sm-face-oo.png", "bump":"sm-facebmp-oo.png"},           
                {"n":"8", "col":"sm-face-M.png", "bump":"sm-facebmp-M.png"},
                {"n":"9", "col":"sm-face-F.png", "bump":"sm-facebmp-F.png"}
            ];

            // Face Manager Class
            class FaceManager {
                constructor() {
                    this.textures = {};
                    this.currentFace = '0';
                    this.isReady = false;
                    this.textureLoader = new THREE.TextureLoader();
                }
                
                async init() {
                    await this.preloadTextures();
                    this.isReady = true;
                    document.getElementById('loading').style.display = 'none';
                    console.log('All face textures loaded and ready');
                }
                
                async preloadTextures() {
                    const loadPromises = faces.map(async (face) => {
                        const [col, bump] = await Promise.all([
                            this.loadTexture(face.col),
                            this.loadTexture(face.bump)
                        ]);
                        this.texfix(col);
                        this.texfix(bump);
                        return { n: face.n, col, bump };
                    });
                    
                    const loaded = await Promise.all(loadPromises);
                    loaded.forEach(texture => {
                        this.textures[texture.n] = texture;
                    });
                }
                
                loadTexture(url) {
                    return new Promise((resolve, reject) => {
                        this.textureLoader.load(url, resolve, undefined, reject);
                    });
                }
                
                texfix(texture) {
                    texture.magFilter = texture.minFilter = THREE.NearestFilter;
                }
                
                setFace(faceIndex) {
                    if (!this.isReady) return;
                    
                    const face = this.textures[faceIndex];
                    if (face && this.currentFace !== faceIndex) {
                        head.material.map = face.col;
                        head.material.displacementMap = face.bump;
                        head.material.needsUpdate = true;
                        this.currentFace = faceIndex;
                    }
                }
                
                // Get a specific texture (for blink, etc.)
                getTexture(faceIndex) {
                    return this.textures[faceIndex];
                }
            }

            // Initialize Face Manager
            const faceManager = new FaceManager();

            // head
            var geometry = new THREE.SphereGeometry(1, 256, 256);
            var material = new THREE.MeshStandardMaterial({
                metalness: 0.01,
                roughness: 0.9,
                map: new THREE.TextureLoader().load("sm-face-clean.png"),
                displacementMap: new THREE.TextureLoader().load("sm-facebmp-clean.png"),
                roughnessMap: new THREE.TextureLoader().load("sm-facerough.png"),
                displacementScale: -1,
            });

            // Apply texture settings
            material.map.magFilter = material.map.minFilter = THREE.NearestFilter;
            material.displacementMap.magFilter = material.displacementMap.minFilter = THREE.NearestFilter;
            material.roughnessMap.magFilter = material.roughnessMap.minFilter = THREE.NearestFilter;

            var head = new THREE.Mesh(geometry, material);
            head.scale.x = 0.8;
            head.scale.y = 0.9;
            head.rotation.y = -Math.PI / 2;
            character.add(head);
            camera.lookAt(head.position);

            // ears
            var bgeometry = new THREE.SphereGeometry(0.3, 8, 12);
            var ear = new THREE.Mesh(
                bgeometry,
                new THREE.MeshStandardMaterial({
                    map: new THREE.TextureLoader().load("v.png"),
                    displacementMap: new THREE.TextureLoader().load("bmp.png"),
                    displacementScale: -0.1,
                }),
            );
            ear.position.set(-0.05, 0.7, 0.35);
            ear.rotation.set(0.1, 0, 0);
            ear.scale.set(0.5, 1.7, 0.6);
            head.add(ear);

            var ear2 = ear.clone();
            ear2.rotation.set(-0.05, 0, -0.1);
            ear2.position.set(-0.1, 0.7, -0.35);
            head.add(ear2);

            // Content Generation Functions
            function generateNewsScript() {
                const rant = require("rant");
                const templates = [
                    `BREAKING: <adj> <noun> reported in <place> causing <amount> of <substance>. <title> <surname> says "<greet>, this is <adv> <quality>!"`,
                    `LOCAL: <firstname> <surname> found <verb.ing> <adj> <noun.plural> in <place>. Authorities are <adv> <verb.ing> the situation.`,
                    `DEVELOPMENT: <place> announces <adj> new <noun> project. <title> <surname> calls it "<adv> <verb.ing>" for the community.`
                ];
                return rant(templates[Math.floor(Math.random() * templates.length)]);
            }

            function generateWeatherReport() {
                const rant = require("rant");
                const templates = [
                    `WEATHER: <adj> <noun.plural> expected to <verb> through <place> this <timenoun>. <adv> <quality> conditions with <amount>% chance of <substance>.`,
                    `FORECAST: <timeadv> will be <adj> with <noun.plural> <verb.ing> from the <preposition>. High of <amount> degrees, low of <amount>.`,
                    `ALERT: <adj> weather system approaching <place>. Expect <adv> <verb.ing> and <amount> <noun.plural>. Stay <quality>!`
                ];
                return rant(templates[Math.floor(Math.random() * templates.length)]);
            }

            function generateSportsNews() {
                const rant = require("rant");
                const templates = [
                    `SPORTS: <adj> victory for <place> <noun.plural>! <firstname> <surname> scored <amount> <noun.plural> while <activity>. "<greet>, we're <adv> <verb.ing>!"`,
                    `GAME UPDATE: <place> <noun.plural> <adv> <verb> against <country> rivals. <title> <surname> described it as "<adj> and <quality>."`,
                    `CHAMPIONSHIP: <adj> <noun> finals in <place>. <firstname> <surname> leads with <amount> <noun.plural>. Fans are <adv> <verb.ing>!`
                ];
                return rant(templates[Math.floor(Math.random() * templates.length)]);
            }

            function generateTechNews() {
                const rant = require("rant");
                const templates = [
                    `TECH: <adj> new <noun> from <place> startup. <title> <surname> says it will <adv> <verb> how we <activity>.`,
                    `INNOVATION: <firstname> <surname> unveils <adj> <noun> that <verb> with <amount>% more <quality>. "<greet>, this changes everything!"`,
                    `DIGITAL: <place> company releases <adj> <noun> update. Users report <adv> <verb.ing> and <amount> new <noun.plural>.`
                ];
                return rant(templates[Math.floor(Math.random() * templates.length)]);
            }

            function generateCelebrityGossip() {
                const rant = require("rant");
                const templates = [
                    `CELEBRITY: <firstname> <surname> spotted <activity> in <place>! Sources say <pron> was <adv> <verb.ing> with <adj> <noun>.`,
                    `HOLLYWOOD: <title> <surname> reveals <adj> new <noun> during <timeadv> interview. "<greet>, it's <adv> <quality>!" <pron> exclaimed.`,
                    `SCANDAL: <firstname> <surname> caught <verb.ing> <adj> <noun.plural> in <place>. "<pron> was just <adv> <verb.ing>," claimed a source.`
                ];
                return rant(templates[Math.floor(Math.random() * templates.length)]);
            }

            function generateShortStory() {
                const rant = require("rant");
                const templates = [
                    `STORY: Once in <place>, <firstname> <surname> discovered <adj> <noun> while <activity>. "<greet>," <pron> whispered, "<adv> <verb.ing> this <quality> thing."`,
                    `TALE: In <adj> <place>, <title> <surname> found <pron>self <verb.ing> <amount> <noun.plural>. The <quality> experience left <pron> <adv> <verb.ed>.`,
                    `ADVENTURE: <firstname> <surname> ventured into <adj> <noun> where <pron> encountered <amount> <adj> <noun.plural>. "<adv> <verb.ing>!" <pron> cried.`
                ];
                return rant(templates[Math.floor(Math.random() * templates.length)]);
            }

            function generateRant() {
                const rant = require("rant");
                return rant('<sound>! <adj> <noun.plural> always <verb> when I\'m <activity>! Why can\'t things just be <adv> <quality>? <vocal>!');
            }

            function generatePoem() {
                const rant = require("rant");
                const templates = [
                    `<adj> <noun> <verb> <adv>\n<preposition> <color> <place>\n<firstname> <surname> <verb> <quality>`,
                    `<timeadv> <noun.plural> <verb>\n<adj> and <adv> <verb.ing>\nIn <place>, <pron> <verb>`,
                    `<noun> of <substance>\n<verb.ing> <adv> <preposition> <place>\n<adj> <timenoun>, <quality> <noun>`
                ];
                return rant(templates[Math.floor(Math.random() * templates.length)]);
            }

            // Content speaking function
            function speakContent(generatorFunction) {
                if (!faceManager.isReady) {
                    console.log("Textures not ready yet");
                    return;
                }
                
                const content = generatorFunction();
                document.querySelector('#subs').innerHTML = content.replace(/\n/g, '<br>');
                mouthshape(content);
                spk(content);
            }

            // look at cursor
            document.addEventListener("pointermove", onPointerMove);
            document.addEventListener("pointerdown", onPointerDown);

            function onPointerMove(event) {
                pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
                pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;

                raycaster.setFromCamera(pointer, camera);

                const intersects = raycaster.intersectObject(plane, true);

                if (intersects.length > 0) {
                    movecursor(intersects[0].point.z, intersects[0].point.y);
                }
            }

            // move cursor
            function movecursor(z, y) {
                mouseMesh.position.z = z;
                mouseMesh.position.y = y;
            }

            //  onPointer down
            function onPointerDown(event) {
                clicked = true;
                blink();
            }

            // blink
            function blink() {
                faceManager.setFace('2'); // blink face
                rnd = Math.floor(Math.random() * 10) * 50;

                if (rnd == 0 || oldrnd == rnd) {
                    return;
                }
                oldrnd = rnd;

                setTimeout(function () {
                    faceManager.setFace('1'); // back to idle
                }, rnd);
            }

            // handle window resize
            window.addEventListener(
                "resize",
                function () {
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                },
                false,
            );

            // Animation Loop
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
                lerpedcursor.position.y +=
                    (mouseMesh.position.y - lerpedcursor.position.y) * 0.2;
                lerpedcursor.position.z +=
                    (mouseMesh.position.z - lerpedcursor.position.z) * 0.2;
                character.lookAt(lerpedcursor.position);
                
                // Random blink
                if (Math.random() > 0.995 && faceManager.isReady) {
                    blink();
                }
            }

            // Speech Synthesis
            var synth = window.speechSynthesis;

            function spk(text) {
                if (!faceManager.isReady) {
                    console.log("Textures not ready yet");
                    return;
                }
                
                var utterThis = new SpeechSynthesisUtterance(text);
                utterThis.pitch = pitch;
                utterThis.rate = rate;

                // change voice
                utterThis.voice = speechSynthesis.getVoices().filter(function(voice) {
                    return voice.name == "Tessa"
                })[0];
 
                synth.speak(utterThis);
            }

            // Lip sync mapping
            const phonemeMap = {
                // Closed mouth
                'silence': '0', ' ': '0', '.': '0', ',': '0',
                
                // Wide open (A, I)
                'a': '3', 'A': '3', 'i': '5', 'I': '5', 'y': '5', 'e': '5', 'E': '5',
                
                // Puckered (O, U)
                'o': '7', 'O': '7', 'u': '7', 'U': '7', 'w': '7', 'q': '7',
                
                // Closed lips (M, B, P)
                'm': '8', 'M': '8', 'b': '8', 'B': '8', 'p': '8',
                
                // Teeth on lip (F, V)
                'f': '9', 'F': '9', 'v': '9', 'V': '9',
                
                // Tongue up (L, N, D, T)
                'l': '6', 'L': '6', 'n': '5', 'N': '5', 'd': '5', 'D': '5', 't': '4', 'T': '4',
                
                // Sibilants (S, Z, C)
                's': '5', 'S': '5', 'z': '5', 'Z': '5', 'c': '5', 'C': '5',
                
                // Gutturals (G, K, H, R)
                'g': '3', 'G': '3', 'k': '3', 'K': '3', 'h': '5', 'H': '5', 'r': '7', 'R': '7',
                
                // Default for unmapped characters
                'default': '0'
            };

            // lip sync to letters
            function mouthshape(text) {
                if (!faceManager.isReady) {
                    console.log("Textures not ready yet");
                    return;
                }
                
                for (let i = 0, len = text.length; i < len; i++) {
                    setTimeout(
                        (function (i) {
                            return function () {
                                lipsync(text[i]);
                            };
                        })(i),
                        speed * i,
                    );
                }
                
                // Return to idle after speaking
                setTimeout(() => {
                    faceManager.setFace('1');
                }, speed * text.length + 200);
            }

            function lipsync(character) {
                const faceIndex = phonemeMap[character] || phonemeMap.default;
                faceManager.setFace(faceIndex);
            }

            // Event Listeners
            document.querySelector('#tellme').addEventListener('click', tellme);

            function tellme(event){
                event.preventDefault();
                var rant = require("rant");
                var val = document.querySelector('#textinput').value;
                var introsentence=rant(val);
                mouthshape(introsentence);
                spk(introsentence);
                document.querySelector('#subs').innerHTML = introsentence;
            }

            // Content buttons
            document.querySelector('#newsbtn').addEventListener('click', () => speakContent(generateNewsScript));
            document.querySelector('#weatherbtn').addEventListener('click', () => speakContent(generateWeatherReport));
            document.querySelector('#sportsbtn').addEventListener('click', () => speakContent(generateSportsNews));
            document.querySelector('#techbtn').addEventListener('click', () => speakContent(generateTechNews));
            document.querySelector('#celebbtn').addEventListener('click', () => speakContent(generateCelebrityGossip));
            document.querySelector('#storybtn').addEventListener('click', () => speakContent(generateShortStory));
            document.querySelector('#rantbtn').addEventListener('click', () => speakContent(generateRant));
            document.querySelector('#poembtn').addEventListener('click', () => speakContent(generatePoem));

            // delete textinput
            document.querySelector('#deletetext').addEventListener('click', deletetxt);
            function deletetxt(){
                document.getElementById("textinput").value = "";    
            }

            // Improved click words to fill textinput
            document.getElementById("words").addEventListener("click", function(e) {
                if (e.target && e.target.tagName === "BUTTON") {
                    const word = e.target.textContent.trim();
                    const input = document.getElementById("textinput");
                    
                    // Smart spacing - don't add space if inserting template tags
                    const currentValue = input.value;
                    const needsSpace = currentValue && 
                                      !currentValue.endsWith(' ') && 
                                      !currentValue.endsWith('<') &&
                                      !word.startsWith('<');
                    
                    input.value = currentValue + (needsSpace ? ' ' : '') + word;
                    
                    // Visual feedback
                    e.target.style.color = '#ff4444';
                    setTimeout(() => {
                        e.target.style.color = '';
                    }, 200);
                }
            });

            // Initialize and start
            faceManager.init().then(() => {
                console.log("Face manager initialized");
                animate();
            });

        </script>
    </body>
</html>
