<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>SHABOOBOO</title>
        <style>
            body {
                margin: 0;
                overflow: hidden;
                background: #000;
                font-family: monospace;
            }
            canvas {
                display: block;
            }
            #hud {
                position: absolute;
                z-index: 99;
                width: 100%;
                left: 0;
                top: 5px;
                text-align: center;
            }
            button:hover {
                cursor: pointer;
            }
            #loading {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                color: white;
                z-index: 100;
            }
            #subs {
                position: absolute;
                z-index: 99;
                bottom: 0;
                left: 0;
                width: 100%;
                font-family: monospace;
                text-align: center;
                color: white;
                height: 2em;
            }
        </style>

        <script type="importmap">
            {
                "imports": {
                    "three": "https://unpkg.com/three@0.170.0/build/three.module.js"
                }
            }
        </script>
    </head>
    <body>
        <div id="loading">Loading</div>
        
        <div id="hud">
            <button id="btn">Speak</button>
            <button id="rantbtn">Rant</button>
        </div>

        <div id="subs"></div>

        <script type="text/javascript" src="rant.min.js"></script>

        <script type="module">
            import * as THREE from "three";

            var clicked = false;
            var rnd = 0;
            var oldrnd = 0;
            var speed = 70; // ANIMATION SPEED
            var rate = 0.85; // SPEECH SPEED
            var pitch = 2; // SPEECH PITCH

            var text = "shaboobu";

            // Scene
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x101010);

            //raycaster
            let raycaster = new THREE.Raycaster();
            const pointer = new THREE.Vector2();

            // Camera
            const camera = new THREE.PerspectiveCamera(
                50,
                window.innerWidth / window.innerHeight,
                0.1,
                1000,
            );
            camera.position.set(4, 0, 0);

            // Renderer
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            THREE.ColorManagement.workingColorSpace = THREE.SRGBColorSpace;

            // Lighting
            const ambient = new THREE.AmbientLight(0xcccccc, 1);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            scene.add(ambient, dirLight);

            // hover plane geometry
            let plgeometry = new THREE.PlaneGeometry(10, 10, 1, 1);

            //plane material
            let plmaterial = new THREE.MeshBasicMaterial({
                transparent: true,
                opacity: 0,
            });

            //plane object3D
            let plane = new THREE.Mesh(plgeometry, plmaterial);
            plane.name = "plane";
            plane.rotation.y = Math.PI / 2;
            plane.position.x = 1;
            scene.add(plane);

            // hidden 3D cursor
            const mouseMesh = new THREE.Group();
            mouseMesh.position.x = 1;
            scene.add(mouseMesh);

            const lerpedcursor = new THREE.Group();
            lerpedcursor.position.x = 1;
            scene.add(lerpedcursor);

            // main character group
            const character = new THREE.Group();
            scene.add(character);

            // textures
            var faces = [
                {"n":"0", "col":"sm-face-clean.png", "bump":"sm-facebmp-clean.png"},
                {"n":"1", "col":"sm-face.png", "bump":"sm-facebmp.png"},
                {"n":"2", "col":"sm-faceblink.png", "bump":"sm-facebmp.png"},            
                {"n":"3", "col":"sm-face-A.png", "bump":"sm-facebmp-A.png"},
                {"n":"4", "col":"sm-face-aaa.png", "bump":"sm-facebmp-aaa.png"}, 
                {"n":"5", "col":"sm-face-E.png", "bump":"sm-facebmp-E.png"},
                {"n":"6", "col":"sm-face-L.png", "bump":"sm-facebmp-L.png"},            
                {"n":"7", "col":"sm-face-oo.png", "bump":"sm-facebmp-oo.png"},           
                {"n":"8", "col":"sm-face-M.png", "bump":"sm-facebmp-M.png"},
                {"n":"9", "col":"sm-face-F.png", "bump":"sm-facebmp-F.png"}
            ];

            // Face Manager Class
            class FaceManager {
                constructor() {
                    this.textures = {};
                    this.currentFace = '0';
                    this.isReady = false;
                    this.textureLoader = new THREE.TextureLoader();
                }
                
                async init() {
                    await this.preloadTextures();
                    this.isReady = true;
                    document.getElementById('loading').style.display = 'none';
                    console.log('All face textures loaded and ready');
                }
                
                async preloadTextures() {
                    const loadPromises = faces.map(async (face) => {
                        const [col, bump] = await Promise.all([
                            this.loadTexture(face.col),
                            this.loadTexture(face.bump)
                        ]);
                        this.texfix(col);
                        this.texfix(bump);
                        return { n: face.n, col, bump };
                    });
                    
                    const loaded = await Promise.all(loadPromises);
                    loaded.forEach(texture => {
                        this.textures[texture.n] = texture;
                    });
                }
                
                loadTexture(url) {
                    return new Promise((resolve, reject) => {
                        this.textureLoader.load(url, resolve, undefined, reject);
                    });
                }
                
                texfix(texture) {
                    texture.magFilter = texture.minFilter = THREE.NearestFilter;
                }
                
                setFace(faceIndex) {
                    if (!this.isReady) return;
                    
                    const face = this.textures[faceIndex];
                    if (face && this.currentFace !== faceIndex) {
                        head.material.map = face.col;
                        head.material.displacementMap = face.bump;
                        head.material.needsUpdate = true;
                        this.currentFace = faceIndex;
                    }
                }
                
                // Get a specific texture (for blink, etc.)
                getTexture(faceIndex) {
                    return this.textures[faceIndex];
                }
            }

            // Initialize Face Manager
            const faceManager = new FaceManager();

            // head
            var geometry = new THREE.SphereGeometry(1, 256, 256);
            var material = new THREE.MeshStandardMaterial({
                metalness: 0.01,
                roughness: 0.9,
                map: new THREE.TextureLoader().load("sm-face.png"),
                displacementMap: new THREE.TextureLoader().load("sm-facebmp.png"),
                roughnessMap: new THREE.TextureLoader().load("sm-facerough.png"),
                displacementScale: -1,
            });

            // Apply texture settings
            material.map.magFilter = material.map.minFilter = THREE.NearestFilter;
            material.displacementMap.magFilter = material.displacementMap.minFilter = THREE.NearestFilter;
            material.roughnessMap.magFilter = material.roughnessMap.minFilter = THREE.NearestFilter;

            var head = new THREE.Mesh(geometry, material);
            head.scale.x = 0.8;
            head.scale.y = 0.9;
            head.rotation.y = -Math.PI / 2;
            character.add(head);
            camera.lookAt(head.position);

            // ears
            var bgeometry = new THREE.SphereGeometry(0.3, 8, 12);
            var ear = new THREE.Mesh(
                bgeometry,
                new THREE.MeshStandardMaterial({
                    map: new THREE.TextureLoader().load("v.png"),
                    displacementMap: new THREE.TextureLoader().load("bmp.png"),
                    displacementScale: -0.1,
                }),
            );
            ear.position.set(-0.05, 0.7, 0.35);
            ear.rotation.set(0.1, 0, 0);
            ear.scale.set(0.5, 1.7, 0.6);
            head.add(ear);

            var ear2 = ear.clone();
            ear2.rotation.set(-0.05, 0, -0.1);
            ear2.position.set(-0.1, 0.7, -0.35);
            head.add(ear2);

            // look at cursor
            document.addEventListener("pointermove", onPointerMove);
            document.addEventListener("pointerdown", onPointerDown);

            function onPointerMove(event) {
                pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
                pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;

                raycaster.setFromCamera(pointer, camera);

                const intersects = raycaster.intersectObject(plane, true);

                if (intersects.length > 0) {
                    movecursor(intersects[0].point.z, intersects[0].point.y);
                }
            }

            // move cursor
            function movecursor(z, y) {
                mouseMesh.position.z = z;
                mouseMesh.position.y = y;
            }

            //  onPointer down
            function onPointerDown(event) {
                clicked = true;
                blink();
            }

            // blink
            function blink() {
                faceManager.setFace('2'); // blink face
                rnd = Math.floor(Math.random() * 10) * 50;

                if (rnd == 0 || oldrnd == rnd) {
                    return;
                }
                oldrnd = rnd;

                setTimeout(function () {
                    faceManager.setFace('1'); // back to idle
                }, rnd);
            }

            // handle window resize
            window.addEventListener(
                "resize",
                function () {
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                },
                false,
            );

            // Animation Loop
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
                lerpedcursor.position.y +=
                    (mouseMesh.position.y - lerpedcursor.position.y) * 0.2;
                lerpedcursor.position.z +=
                    (mouseMesh.position.z - lerpedcursor.position.z) * 0.2;
                character.lookAt(lerpedcursor.position);
                
                // Random blink
                if (Math.random() > 0.995 && faceManager.isReady) {
                    blink();
                }
            }

            // Speech Synthesis
            var synth = window.speechSynthesis;

            function spk(text) {
                if (!faceManager.isReady) {
                    console.log("Textures not ready yet");
                    return;
                }
                
                var utterThis = new SpeechSynthesisUtterance(text);
                utterThis.pitch = pitch;
                utterThis.rate = rate;

                // change voice
                utterThis.voice = speechSynthesis.getVoices().filter(function(voice) {
                    return voice.name == "Tessa"
                })[0];
 
                synth.speak(utterThis);
            }

            // Lip sync mapping
            const phonemeMap = {
                // Closed mouth
                'silence': '0', ' ': '0', '.': '0', ',': '0',
                
                // Wide open (A, I)
                'a': '3', 'A': '3', 'i': '5', 'I': '5', 'y': '5', 'e': '5', 'E': '5',
                
                // Puckered (O, U)
                'o': '7', 'O': '7', 'u': '7', 'U': '7', 'w': '7', 'q': '7',
                
                // Closed lips (M, B, P)
                'm': '8', 'M': '8', 'b': '8', 'B': '8', 'p': '8',
                
                // Teeth on lip (F, V)
                'f': '9', 'F': '9', 'v': '9', 'V': '9',
                
                // Tongue up (L, N, D, T)
                'l': '6', 'L': '6', 'n': '5', 'N': '5', 'd': '5', 'D': '5', 't': '4', 'T': '4',
                
                // Sibilants (S, Z, C)
                's': '5', 'S': '5', 'z': '5', 'Z': '5', 'c': '5', 'C': '5',
                
                // Gutturals (G, K, H, R)
                'g': '3', 'G': '3', 'k': '3', 'K': '3', 'h': '5', 'H': '5', 'r': '7', 'R': '7',
                
                // Default for unmapped characters
                'default': '0'
            };

            // lip sync to letters
            function mouthshape(text) {
                if (!faceManager.isReady) {
                    console.log("Textures not ready yet");
                    return;
                }
                
                for (let i = 0, len = text.length; i < len; i++) {
                    setTimeout(
                        (function (i) {
                            return function () {
                                lipsync(text[i]);
                            };
                        })(i),
                        speed * i,
                    );
                }
                
                // Return to idle after speaking
                setTimeout(() => {
                    faceManager.setFace('1');
                }, speed * text.length + 200);
            }

            function lipsync(character) {
                const faceIndex = phonemeMap[character] || phonemeMap.default;
                faceManager.setFace(faceIndex);
            }

            document.querySelector('#btn').addEventListener('click', hello);

            function hello(){
                mouthshape(text);
                spk(text);
                document.querySelector('#subs').innerHTML = text;
            }

            document.querySelector('#rantbtn').addEventListener('click', sayit);

            function sayit(){
                var rant = require("rant");
                var introsentence=rant('<verb.ing> <adj> <noun.plural> with my <noun -body>');
                mouthshape(introsentence);
                spk(introsentence);
                document.querySelector('#subs').innerHTML = introsentence;
            }

            // Initialize and start
            faceManager.init().then(() => {
                console.log("Face manager initialized");
                animate();
            });
        </script>
    </body>
</html>
