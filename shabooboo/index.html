<!-- to do:
1. tongue (sphere behind teeth)
2. 5 mouth shapes
3. blink
-->
<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>SHABOOBOO</title>
        <style>
            body {
                margin: 0;
                overflow: hidden;
                background: #000;
            }
            canvas {
                display: block;
            }
            .info {
                position: absolute;
                z-index: 99;
                display: none;
            }
            #hud {
                position: absolute;
                z-index: 99;
                width: 100%;
                left: 0;
                top: 5px;
                text-align: center;
            }
            #btn {
                cursor: pointer;
            }
        </style>

        <script type="importmap">
            {
                "imports": {
                    "three": "https://unpkg.com/three@0.170.0/build/three.module.js"
                }
            }
        </script>
    </head>
    <body>
        <div id="hud">
            <button id="btn">x</button>
        </div>
        
        <div class="info">
            <form onsubmit="sendMessage();return false" id="inform">
                <button type="submit" value="Send" id="sendmsg">&gt;</button>
                <input
                    type="text"
                    size="32"
                    name="message"
                    id="input"
                    autocomplete="off"
                    onkeyup="cleanbf()"
                    onkeydown="cleanbf()"
                    tabindex="1"
                    value="My uncle"
                />

                <input
                    type="range"
                    min="0"
                    max="2"
                    value="1"
                    step="0.1"
                    id="pitch"
                />

                <input
                    type="range"
                    min="0.5"
                    max="2"
                    value="1"
                    step="0.1"
                    id="rate"
                />
            </form>
            <select selected="Fred"></select>
        </div>

        <!-- <script type="text/javascript" src="zzfx.js"></script> -->

        <script type="module">
            import * as THREE from "three";

            var clicked = false;
            var rnd = 0;
            var oldrnd = 0;
            var speed = 10;
            var text = "shaboobu";


            // Scene
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x101010);

            //raycaster
            let raycaster = new THREE.Raycaster();
            const pointer = new THREE.Vector2();

            // Camera
            const camera = new THREE.PerspectiveCamera(
                50,
                window.innerWidth / window.innerHeight,
                0.1,
                1000,
            );
            camera.position.set(4, 0, 0);

            // Renderer
            const renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            THREE.ColorManagement.workingColorSpace = THREE.SRGBColorSpace;

            // Lighting
            const ambient = new THREE.AmbientLight(0xcccccc, 1);

            const dirLight = new THREE.DirectionalLight(0xffffff, 0.5);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            scene.add(ambient, dirLight);

            // hover plane geometry
            let plgeometry = new THREE.PlaneGeometry(10, 10, 1, 1);

            //plane material
            let plmaterial = new THREE.MeshBasicMaterial({
                transparent: true,
                opacity: 0,
            });

            //plane object3D
            let plane = new THREE.Mesh(plgeometry, plmaterial);
            plane.name = "plane";
            plane.rotation.y = Math.PI / 2;
            plane.position.x = 1;
            scene.add(plane);

            // hidden 3D cursor
            const mouseMesh = new THREE.Group();
            mouseMesh.position.x = 1;
            scene.add(mouseMesh);

            const lerpedcursor = new THREE.Group();
            lerpedcursor.position.x = 1;
            scene.add(lerpedcursor);

            // main character group
            const character = new THREE.Group();
            scene.add(character);

            // textures
            // ready:
            // sm-facerough.png
            
            var faces = [
            {"n":"0", "col":"sm-face-clean.png", 
            "bump":"sm-facebmp-clean.png"},
            {"n":"1", "col":"sm-face.png",   
            "bump":"sm-facebmp.png"},
            {"n":"2", "col":"sm-faceblink.png",  
            "bump":"sm-facebmp.png"},            
            {"n":"3", "col":"sm-face-A.png", 
             "bump":"sm-facebmp-A.png"},
            {"n":"4", "col":"sm-face-aaa.png",   
            "bump":"sm-facebmp-aaa.png"}, 
            {"n":"5", "col":"sm-face-E.png", 
            "bump":"sm-facebmp-E.png"},
            {"n":"6", "col":"sm-face-L.png", 
            "bump":"sm-facebmp-L.png"},            
            {"n":"7", "col":"sm-face-oo.png",    
            "bump":"sm-facebmp-oo.png"},           
            {"n":"8", "col":"sm-face-M.png", 
            "bump":"sm-facebmp-M.png"},
            {"n":"9", "col":"sm-face-F.png", 
            "bump":"sm-facebmp-F.png"}
            ]

            //
            // for (var i = 0; i < faces.length; i++) {
            //    console.log(faces[i].n, faces[i].col, faces[i].bump);
            //    // faces[i].push("texcol",new THREE.TextureLoader().load(faces[i].col))
            // }

            var blinkface = new THREE.TextureLoader().load("sm-faceblink.png");
            var idleface = new THREE.TextureLoader().load("sm-face.png");
            texfix(blinkface);
            texfix(idleface);

            // head
            var geometry = new THREE.SphereGeometry(1, 256, 256);
            var material = new THREE.MeshStandardMaterial({
                metalness: 0.01,
                roughness: 0.9,
                map: new THREE.TextureLoader().load("sm-face.png"),
                displacementMap: new THREE.TextureLoader().load(
                    "sm-facebmp.png",
                ),
                roughnessMap: new THREE.TextureLoader().load(
                    "sm-facerough.png",
                ),
                displacementScale: -1,
            });

            texfix(material.map);
            var head = new THREE.Mesh(geometry, material);
            head.scale.x = 0.8;
            head.scale.y = 0.9;
            head.rotation.y = -Math.PI / 2;
            character.add(head);
            camera.lookAt(head.position);

            // ears
            var bgeometry = new THREE.SphereGeometry(0.3, 8, 12);
            var ear = new THREE.Mesh(
                bgeometry,
                new THREE.MeshStandardMaterial({
                    map: new THREE.TextureLoader().load("v.png"),
                    displacementMap: new THREE.TextureLoader().load("bmp.png"),
                    displacementScale: -0.1,
                }),
            );
            ear.position.set(-0.05, 0.7, 0.35);
            ear.rotation.set(0.1, 0, 0);
            ear.scale.set(0.5, 1.7, 0.6);
            head.add(ear);

            var ear2 = ear.clone();
            ear2.rotation.set(-0.05, 0, -0.1);
            ear2.position.set(-0.1, 0.7, -0.35);
            head.add(ear2);

            //
            function texfix(argument) {
                argument.magFilter = argument.minFilter = THREE.NearestFilter;
            }

            // look at cursor
            document.addEventListener("pointermove", onPointerMove);
            document.addEventListener("pointerdown", onPointerDown);

            function onPointerMove(event) {
                pointer.x = (event.clientX / window.innerWidth) * 2 - 1;
                pointer.y = -(event.clientY / window.innerHeight) * 2 + 1;

                raycaster.setFromCamera(pointer, camera);

                const intersects = raycaster.intersectObject(plane, true);

                if (intersects.length > 0) {
                    movecursor(intersects[0].point.z, intersects[0].point.y);
                }
            }

            // move cursor
            function movecursor(z, y) {
                mouseMesh.position.z = z;
                mouseMesh.position.y = y;
            }

            //  onPointer down
            function onPointerDown(event) {
                clicked = true;
                blink();
            }

            // blink
            function blink() {
                head.material.map = blinkface;
                head.material.map.needsUpdate = true;
                rnd = Math.floor(Math.random() * 10) * 50;

                if (rnd == 0 || oldrnd == rnd) {
                    return;
                }
                oldrnd = rnd;

                // if (clicked) {
                // zzfx(...[.1,2.6,300,.02,.01,.008,,1.1,-80,86,,,,,106,,,.91,.01,.2,-1040]);
                // }

                setTimeout(function () {
                    // if (clicked) {
                    // zzfx(...[.1,2.6,800,.02,.01,.008,,1.1,-80,86,,,,,106,,,.91,.01,.2,-1040]); // Blip 255
                    // }
                    head.material.map = idleface;
                    head.material.map.needsUpdate = true;
                }, rnd);
            }

            // handle window resize
            window.addEventListener(
                "resize",
                function () {
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                },
                false,
            );

            // Animation Loop
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
                lerpedcursor.position.y +=
                    (mouseMesh.position.y - lerpedcursor.position.y) * 0.2;
                lerpedcursor.position.z +=
                    (mouseMesh.position.z - lerpedcursor.position.z) * 0.2;
                character.lookAt(lerpedcursor.position);
                // if (Math.random() > 0.99) {
                //     blink();
                // }
            }

            //

            var synth = window.speechSynthesis;
            var voiceSelect = document.querySelector("select");
            var voices = [];

            // var pitch = document.querySelector('#pitch');
            // var rate = document.querySelector('#rate');

            function spk(text) {
                var utterThis = new SpeechSynthesisUtterance(text);
                var selectedOption =
                    voiceSelect.selectedOptions[0].getAttribute("data-name");
                for (var i = 0; i < voices.length; i++) {
                    if (voices[i].name === selectedOption) {
                        utterThis.voice = voices[i];
                    }
                }
                utterThis.pitch = pitch.value * (text.length * 0.3);
                utterThis.rate = rate.value;

                // change voice
                utterThis.voice = speechSynthesis.getVoices().filter(function(voice) {
                    return voice.name == "Tessa"
                  })[0];
 
                synth.speak(utterThis);
                // bubble.innerHTML = text;
            }

            // lip sync to letters
            function mouthshape(text) {
                for (let i = 0, len = text.length; i < len; i++) {
                    setTimeout(
                        (function (i) {
                            return function () {
                                lipsync(text[i]);
                            };
                        })(i),
                        speed * i,
                    );
                } //for
            } // end mouthshape

            // shapes
            function lipsync(arg) {
                if (arg == " " || arg == ".") {
                    setface(0);
                }
                if (arg == "a" || arg == "A") {
                    setface(3);
                }
                if (arg == "b" || arg == "B") {
                    setface(8);
                }
                if (arg == "c" || arg == "C") {
                    setface(5);
                }
                if (arg == "d" || arg == "D") {
                    setface(5);
                }
                if (arg == "e" || arg == "E") {
                    setface(5);
                }
                if (arg == "f" || arg == "F") {
                    setface(9);
                }
                if (arg == "g" || arg == "G") {
                    setface(7);
                }
                if (arg == "h" || arg == "H") {
                    setface(5);
                }
                if (arg == "i" || arg == "I") {
                    setface(5);
                }
                if (arg == "j" || arg == "J") {
                    setface(7);
                }
                if (arg == "k" || arg == "K") {
                    setface(3);
                }
                if (arg == "l" || arg == "L") {
                    setface(6);
                }
                if (arg == "m" || arg == "M") {
                    setface(8);
                }
                if (arg == "n" || arg == "N") {
                    setface(5);
                }
                if (arg == "o" || arg == "O") {
                    setface(7);
                }
                if (arg == "p" || arg == "P") {
                    setface(8);
                }
                if (arg == "q" || arg == "Q") {
                    setface(7);
                }
                if (arg == "r" || arg == "R") {
                    setface(7);
                }
                if (arg == "s" || arg == "S") {
                    setface(5);
                }
                if (arg == "t" || arg == "T") {
                    setface(1);
                }
                if (arg == "u" || arg == "U") {
                    setface(7);
                }
                if (arg == "v" || arg == "V") {
                    setface(9);
                }
                if (arg == "w" || arg == "W") {
                    setface(7);
                }
                if (arg == "x" || arg == "X") {
                    setface(3);
                }
                if (arg == "y" || arg == "Y") {
                    setface(5);
                }
                if (arg == "z" || arg == "Z") {
                    setface(3);
                }
            }

            // set mouth shape
            function setface(argument) {
                head.material.map = new THREE.TextureLoader().load(faces[argument].col);
                head.material.map.needsUpdate = true;
                head.material.displacementMap = new THREE.TextureLoader().load(faces[argument].bump);
                head.material.displacementMap.needsUpdate = true;
            }

            // wait for voices to be loaded before fetching list
            window.speechSynthesis.onvoiceschanged = function () {
                var xvoices = window.speechSynthesis.getVoices();
            };
            //

            function populateVoiceList() {
                voices = synth.getVoices();

                for (var i = 0; i < voices.length; i++) {
                    var option = document.createElement("option");
                    option.textContent =
                        voices[i].name + " (" + voices[i].lang + ")";

                    if (voices[i].default) {
                        option.textContent += " -- DEFAULT";
                    }

                    option.setAttribute("data-lang", voices[i].lang);
                    option.setAttribute("data-name", voices[i].name);
                    voiceSelect.appendChild(option);
                }
            }

            populateVoiceList();
            if (speechSynthesis.onvoiceschanged !== undefined) {
                speechSynthesis.onvoiceschanged = populateVoiceList;
            }



            document.querySelector('#btn').addEventListener('click', hello)

            function hello(){
                mouthshape(text);
                spk(text);
                // console.log(text);                
            }

            // start
            // console.log(faces)
            animate();


        </script>
    </body>
</html>
